{% extends 'base.html' %}
{% load static %}
{% load producto_templatetags %}
{% block extra_css %}
<style>
    /* Estilos generales */
    :root {
        --primary-color: #007bff;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --border-color: #e0e0e0;
    }

    body {
        background-color: #f5f5f5;
    }

    /* Header principal */
    .main-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .main-header h2 {
        margin: 0;
        font-weight: 600;
    }

    /* Barra de b칰squeda mejorada */
    .search-section {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .search-container {
        position: relative;
        max-width: 500px;
        margin: 0 auto;
    }

    .search-input {
        padding: 12px 20px 12px 45px;
        border-radius: 25px;
        border: 2px solid #e0e0e0;
        font-size: 16px;
        width: 100%;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        outline: none;
    }

    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
        font-size: 18px;
    }

    /* Categor칤as horizontales */
    .categories-section {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .categories-title {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .categories-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 5px;
    }

    .categoria-btn {
        padding: 8px 16px;
        border: 2px solid #e0e0e0;
        background: white;
        color: var(--dark-color);
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.3s ease;
        cursor: pointer;
        min-width: fit-content;
    }

    .categoria-btn:hover {
        border-color: var(--primary-color);
        background-color: #f8f9ff;
    }

    .categoria-btn.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(0,123,255,0.3);
    }

    /* Lista de productos simplificada */
    .products-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .products-header {
        background-color: var(--light-color);
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--dark-color);
    }

    .producto-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
        min-height: 60px;
    }
    .producto-info {
        flex: 1;
        padding-right: 10px;
    }

    .producto-nombre {
        font-weight: 600;
        color: var(--dark-color);
        font-size: 15px;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .producto-item:hover {
        background-color: #f8f9fa;
    }

    .producto-item:last-child {
        border-bottom: none;
    }
    .producto-precio {
        color: var(--success-color);
        font-weight: 700;
        font-size: 15px;
        margin-left: auto;
        white-space: nowrap;
    }
  
    .producto-descripcion {
        color: var(--secondary-color);
        font-size: 13px;
        margin: 2px 0 0 0;
    }

    .producto-categoria {
        background-color: #e3f2fd;
        color: #1976d2;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        width: fit-content;
    }

    .producto-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .add-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 18px;
    }

    .add-btn:hover {
        background-color: #0056b3;
        transform: scale(1.1);
    }

    .add-btn:active {
        transform: scale(0.95);
    }

    /* Modal para notas */
    .note-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .note-modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: fadeIn 0.3s ease;
    }

    .note-modal h4 {
        margin: 0 0 15px 0;
        color: var(--dark-color);
    }

    .note-input {
        width: 100%;
        height: 80px;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        resize: vertical;
        font-family: inherit;
        margin-bottom: 15px;
    }

    .note-input:focus {
        border-color: var(--primary-color);
        outline: none;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-cancel {
        background-color: #f8f9fa;
        color: var(--secondary-color);
        border: 1px solid #ddd;
    }

    .btn-confirm {
        background-color: var(--primary-color);
        color: white;
    }

    .btn-cancel:hover {
        background-color: #e9ecef;
    }

    .btn-confirm:hover {
        background-color: #0056b3;
    }


    /* Carrito lateral */
    .cart-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        max-height: 90vh;
        overflow-y: auto;
        position: sticky;
        top: 20px;
    }

    .cart-header {
        background: linear-gradient(135deg, var(--secondary-color), #5a6268);
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: between;
        align-items: center;
        border-radius: 8px 8px 0 0;
    }

    .cart-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .cart-badge {
        background-color: white;
        color: var(--secondary-color);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-left: auto;
    }

    .cart-body {
        padding: 1rem;
    }


    .cart-item {
       padding: 10px 0;
       display: flex;
       flex-direction: column;
       gap: 5px;
    }

    .cart-item-info {
        width: 100%;
    }


    .cart-item:last-child {
        border-bottom: none;
    }

    .cart-item-name {
        font-weight: 600;
        margin: 0 0 4px 0;
        font-size: 14px;
    }

    .cart-item-price {
        color: var(--secondary-color);
        font-size: 13px;
        margin: 0;
    }

    .cart-item-note {
        background-color: #f5f5f5;
        color: #666;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-top: 4px;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px dashed #ddd;
        min-height: 28px;
    }
    .cart-item-note:hover {
        background-color: #fff8e1;
        border-color: #ffc107;
    }
    .cart-item-note i {
        color: #ffc107;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .quantity-btn {
        width: 28px;
        height: 28px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .quantity-btn:hover {
        background-color: #f8f9fa;
        border-color: var(--primary-color);
    }

    .quantity-value {
        min-width: 30px;
        text-align: center;
        font-weight: 600;
    }

    .remove-btn {
        color: var(--danger-color);
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
        padding: 4px;
        transition: transform 0.2s ease;
    }

    .remove-btn:hover {
        transform: scale(1.2);
    }

    .cart-total {
        background-color: var(--light-color);
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .total-label {
        font-weight: 600;
        font-size: 18px;
    }

    .total-amount {
        font-weight: 700;
        font-size: 24px;
        color: var(--success-color);
    }

    .confirm-btn {
        width: 100%;
        background: linear-gradient(135deg, var(--success-color), #1e7e34);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
   
    .confirm-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40,167,69,0.3);
    }

    .empty-cart {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--secondary-color);
    }

    .empty-cart i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .categories-wrapper {
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .producto-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
        
        .producto-actions {
            width: 100%;
            justify-content: flex-end;
        }
        
        .cart-container {
            position: static;
            margin-top: 1rem;
        }
    }

    /* Animaciones */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .categoria-productos {
        animation: fadeIn 0.3s ease;
    }

    .pulse {
        animation: pulse 0.3s ease;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    .cliente-field {
        background-color: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .cliente-field label {
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
    }

    #nombre_cliente {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    #guardar-cliente {
        background-color: #28a745;
        border: none;
        padding: 5px 10px;
        font-size: 13px;
    }
    .note-btn {
        background: none;
        border: none;
        color: #ffc107;
        font-size: 16px;
        cursor: pointer;
        padding: 4px;
        transition: all 0.2s ease;
    }

    .note-btn:hover {
        transform: scale(1.2);
        color: #ffab00;
    }

    .producto-con-nota .note-btn {
        color: #ffab00;
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Header Principal -->
    <div class="main-header">
        <h2><i class="fas fa-utensils me-2"></i>Venta Local - Mesa {{ mesa.numero }}</h2>
    </div>

    <div class="row">
        <!-- Secci칩n de productos -->
        <div class="col-lg-8 col-md-7 mb-4">
            <!-- Barra de b칰squeda -->
            <div class="search-section">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="producto-search" class="search-input" 
                           placeholder="Buscar producto por nombre...">
                </div>
            </div>

            <!-- Categor칤as -->
            <div class="categories-section">
                <h3 class="categories-title">
                    <i class="fas fa-th-large"></i>
                    Cat치logo de Productos
                </h3>
                <div class="categories-wrapper">
                    <button class="categoria-btn active" data-categoria="all">
                        <i class="fas fa-th"></i> Todas
                    </button>
                    {% for categoria in categorias %}
                        <button class="categoria-btn" data-categoria="{{ categoria.id }}">
                            {{ categoria.nombre }}
                        </button>
                    {% endfor %}
                </div>
            </div>
            <!-- Lista de productos -->
            <div class="products-section">
                <div class="products-header">
                    <span id="category-title">Todos los productos</span>
                </div>
                
                {% for categoria in categorias %}
                    <div class="categoria-productos" id="categoria-{{ categoria.id }}" 
                         data-categoria="{{ categoria.id }}" style="display: none;">
                        {% for producto in productos_por_categoria|get_item:categoria %}
                        <div class="producto-item" data-nombre="{{ producto.nombre|lower }}" 
                             data-categoria="{{ categoria.id }}">
                            <div class="producto-info">
                                <h5 class="producto-nombre">{{ producto.nombre }}</h5>                          
                                <div class="producto-precio">${{ producto.precio|floatformat:0 }}</div>                              
                            </div>
                            <div class="producto-actions">
                                <button type="button" class="note-btn" onclick="openNoteModal({{ producto.id }}, '{{ producto.nombre|escapejs }}')" title="Agregar nota">
                                    <i class="fas fa-sticky-note"></i>
                                </button>
                                <form method="post" action="{% url 'orders:tomar_pedido' mesa.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="add_producto">
                                    <input type="hidden" name="producto_id" value="{{ producto.id }}">
                                    <input type="hidden" name="cantidad" value="1">
                                    <input type="hidden" name="categoria_activa" value="{{ categoria.id }}">
                                    <input type="hidden" name="notas" id="notas-{{ producto.id }}" value="">
                                    <button type="submit" class="add-btn" title="Agregar {{ producto.nombre }}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% endfor %}         
                <!-- Productos de todas las categor칤as (vista inicial) -->
                <div class="categoria-productos" id="categoria-all" data-categoria="all">
                    {% for categoria in categorias %}
                        {% for producto in productos_por_categoria|get_item:categoria %}
                        <div class="producto-item" data-nombre="{{ producto.nombre|lower }}" 
                            data-categoria="{{ categoria.id }}">
                            <div class="producto-info">
                                <h5 class="producto-nombre">{{ producto.nombre }}</h5>
                                <div class="producto-precio">${{ producto.precio|floatformat:0 }}</div>
                            </div>
                            <div class="producto-actions">                               
                                <form method="post" action="{% url 'orders:tomar_pedido' mesa.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="add_producto">
                                    <input type="hidden" name="producto_id" value="{{ producto.id }}">
                                    <input type="hidden" name="cantidad" value="1">
                                    <input type="hidden" name="categoria_activa" value="{{ categoria.id }}">
                                    <input type="hidden" name="notas" id="notas-{{ producto.id }}" value="">
                                    <button type="submit" class="add-btn" title="Agregar {{ producto.nombre }}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Carrito -->
        <div class="col-lg-4 col-md-5">
            <div class="cart-container">
                <div class="cart-header">
                    <h3 class="cart-title">
                        <i class="fas fa-shopping-cart me-2"></i>Carrito - Mesa {{ mesa.numero }}
                    </h3>
                    <span class="cart-badge">{{ pedido_existente.detalles.count|default:0 }} 칤tems</span>
                </div>
                <div class="cart-body">
                    <div class="mb-3 cliente-field">
                        <label for="nombre_cliente" class="form-label">Nombre del Cliente:</label>
                        <input type="text" class="form-control" id="nombre_cliente" 
                            value="{{ pedido_existente.nombre_cliente|default:'' }}"
                            placeholder="Ingrese nombre del cliente">
                        <button id="guardar-cliente" class="btn btn-sm btn-primary mt-2">Guardar</button>
                    </div>
                    {% if pedido_existente %}
                        {% for detalle in pedido_existente.detalles.all %}
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <div style="display: flex; justify-content: space-between; width: 100%;">
                                    <h6 class="cart-item-name">{{ detalle.producto.nombre }}</h6>                                   
                                    <p class="cart-item-price" data-detalle-id="{{ detalle.id }}">${{ detalle.subtotal|floatformat:0 }}</p>
                                </div>
                                <div class="cart-item-note" 
                                    onclick="editNote({{ detalle.id }}, '{{ detalle.notas|escapejs }}', '{{ detalle.producto.nombre|escapejs }}')">
                                    <i class="fas fa-sticky-note me-1"></i>
                                    {{ detalle.notas|default:"<span style='color:#999'>[Agregar nota]</span>"|safe }}
                                </div>
                            </div>
                            <div class="quantity-controls">
                                <button class="quantity-btn decrementar" data-detalle-id="{{ detalle.id }}">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="quantity-value" data-detalle-id="{{ detalle.id }}">
                                    {{ detalle.cantidad }}
                                </span>
                                <button class="quantity-btn incrementar" data-detalle-id="{{ detalle.id }}">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="remove-btn" data-detalle-id="{{ detalle.id }}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="cart-total">
                            <span class="total-label">Total</span>
                            <span class="total-amount">${{ total_pedido|floatformat:0 }}</span>
                        </div>
                        
                        <button class="confirm-btn" onclick="window.location.href='{% url 'users:dashboard' %}'">
                            <i class="fas fa-check-circle me-2"></i>Confirmar Pedido
                        </button>
                    {% else %}
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <h5>Carrito vac칤o</h5>
                            <p>Agrega productos desde el men칰</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para notas -->
    <div id="noteModal" class="note-modal">
        <div class="note-modal-content">
            <h4 id="noteModalTitle">Agregar nota</h4>
            <textarea id="noteInput" class="note-input" placeholder="Escribe una nota para este producto..."></textarea>
            <div class="modal-buttons">
                <button type="button" class="modal-btn btn-cancel" onclick="closeNoteModal()">Cancelar</button>
                <button type="button" class="modal-btn btn-confirm" onclick="confirmNote()">Agregar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Seguridad - bloquear actualizaciones autom치ticas
    (function() {
        console.log("游 Tomar Pedido - Inicializando medidas de seguridad");
        
        // Configurar flags de seguridad
        window.disableActivityUpdates = true;
        window.isTomarPedido = true;
        window.preventRefresh = true;
        
        // Limpiar timeout de actividad existente
        if (window.activityTimeout) {
            clearTimeout(window.activityTimeout);
            console.log("游띔 Timeout de actividad limpiado");
        }
        
        // Bloquear funci칩n de actualizaci칩n de actividad
        if (typeof window.updateUserActivity === 'function') {
            window.originalUpdateUserActivity = window.updateUserActivity;
            window.updateUserActivity = function() {
                console.log("游띔 Bloqueado intento de actualizaci칩n en Tomar Pedido");
                return Promise.resolve();
            };
        }
        
        // Remover event listeners de actividad
        const activityEvents = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
        activityEvents.forEach(event => {
            if (window.handleUserActivity) {
                document.removeEventListener(event, window.handleUserActivity);
            }
        });
    })();

    {% if debug %}
    console.log("Debug - Detalles del pedido:");
    {% if pedido_existente %}
        {% for detalle in pedido_existente.detalles.all %}
            console.log("Producto: {{ detalle.producto.nombre }}, Notas: '{{ detalle.notas }}'");
        {% endfor %}
    {% endif %}
    {% endif %}

    
    // Variables globales para el modal de notas
    let currentProductId = null;
    let currentProductName = '';

    // Funci칩n para abrir modal de notas
    function openNoteModal(productId, productName) {
        currentProductId = productId;
        currentProductName = productName;
            
        const modal = document.getElementById('noteModal');
        const title = document.getElementById('noteModalTitle');
        const input = document.getElementById('noteInput');
        
        // Validar que los elementos existan
        if (!modal || !title || !input) {
            console.error('Elementos del modal no encontrados');
            return;
        }
            
        title.textContent = `Agregar nota - ${productName}`;
        input.value = '';
        input.focus();
        modal.style.display = 'block';
    }

    // Funci칩n para cerrar modal
    function closeNoteModal() {
        const modal = document.getElementById('noteModal');
        if (modal) {
            modal.style.display = 'none';
        }
        currentProductId = null;
        currentProductName = '';
    }

    // Funci칩n para confirmar nota
    function confirmNote() {
        const noteInput = document.getElementById('noteInput');
        if (!noteInput) {
            console.error('Input de nota no encontrado');
            return;
        }
        
        const note = noteInput.value.trim();
            
        if (currentProductId) {
            const notasInput = document.getElementById(`notas-${currentProductId}`);
            if (notasInput) {
                notasInput.value = note;
            }
                
            if (note) {
                Swal.fire({
                    icon: 'success',
                    title: 'Nota agregada',
                    text: `Nota agregada a ${currentProductName}`,
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        }
            
        closeNoteModal();
    }
    
    // A칌ADE AQU칈 LAS NUEVAS FUNCIONES (editNote y updateNote)

    function editNote(detalleId, currentNote, productName) {
        const modal = document.getElementById('noteModal');
        const title = document.getElementById('noteModalTitle');
        const input = document.getElementById('noteInput');
        
        title.textContent = `Nota para ${productName}`;
        input.value = currentNote === '[Agregar nota]' ? '' : currentNote;
        input.focus();
        modal.style.display = 'block';
        
        const confirmBtn = document.querySelector('.btn-confirm');
        confirmBtn.textContent = currentNote ? 'Actualizar' : 'Agregar';
        confirmBtn.onclick = function() {
            updateNote(detalleId);
        };
    }

    function updateNote(detalleId) {
        const noteInput = document.getElementById('noteInput');
        const note = noteInput.value.trim();
        const csrfToken = getCsrfToken();
        const categoriaActiva = localStorage.getItem('categoriaActiva') || 'all';
        
        fetch('', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: `action=update_note&detalle_id=${detalleId}&notas=${encodeURIComponent(note)}&categoria_activa=${categoriaActiva}`
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else if (response.ok) {
                window.location.reload();
            }
        })
        .catch(error => {
            handleFetchError(error, 'Error al actualizar la nota');
        });
    }



    // Utilitario para obtener token CSRF
    function getCsrfToken() {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfInput ? csrfInput.value : '';
    }
    
    // Funci칩n para manejar errores de fetch
    function handleFetchError(error, defaultMessage = 'Ocurri칩 un error inesperado') {
        console.error('Error:', error);
        Swal.fire('Error', defaultMessage, 'error');
    }

    document.addEventListener('DOMContentLoaded', function() {
        
        // Funci칩n para activar categor칤a
        function activateCategory(categoriaId) {
            const categoriaProductos = document.querySelectorAll('.categoria-productos');
            const categoriaBtns = document.querySelectorAll('.categoria-btn');
            const categoryTitle = document.getElementById('category-title');
            
            // Ocultar todos los productos
            categoriaProductos.forEach(el => {
                el.style.display = 'none';
            });
    
            // Desactivar botones
            categoriaBtns.forEach(el => {
                el.classList.remove('active');
            });
    
            // Mostrar productos de la categor칤a seleccionada
            const productos = document.getElementById(`categoria-${categoriaId}`);
            if (productos) {
                productos.style.display = 'block';
                localStorage.setItem('categoriaActiva', categoriaId);
                
                // Actualizar t칤tulo
                const activeBtn = document.querySelector(`.categoria-btn[data-categoria="${categoriaId}"]`);
                if (activeBtn && categoryTitle) {
                    categoryTitle.textContent = categoriaId === 'all' 
                        ? 'Todos los productos' 
                        : activeBtn.textContent.trim();
                }
            }
    
            // Activar bot칩n actual
            const currentBtn = document.querySelector(`.categoria-btn[data-categoria="${categoriaId}"]`);
            if (currentBtn) {
                currentBtn.classList.add('active');
            }
        }
        
        // Event listeners para botones de categor칤a
        const categoriaBtns = document.querySelectorAll('.categoria-btn');
        categoriaBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const categoriaId = this.dataset.categoria;
                if (categoriaId) {
                    activateCategory(categoriaId);
                }
            });
        });

        // Mostrar todos los productos por defecto o categor칤a guardada
        const categoriaGuardada = localStorage.getItem('categoriaActiva') || 'all';
        activateCategory(categoriaGuardada);
    
        // Funci칩n de b칰squeda mejorada
        function searchProducts(query) {
            const normalizedQuery = query.toLowerCase().trim();
            const allProducts = document.querySelectorAll('.producto-item');
            
            if (normalizedQuery === '') {
                // Mostrar todos los productos
                allProducts.forEach(product => {
                    product.style.display = 'flex';
                });
                return;
            }
            
            // Filtrar productos
            let hasResults = false;
            allProducts.forEach(product => {
                const productName = product.dataset.nombre;
                if (productName && productName.toLowerCase().includes(normalizedQuery)) {
                    product.style.display = 'flex';
                    hasResults = true;
                } else {
                    product.style.display = 'none';
                }
            });
            
            // Mostrar mensaje si no hay resultados
            if (!hasResults) {
                Swal.fire({
                    icon: 'info',
                    title: 'No se encontraron productos',
                    text: 'No hay productos que coincidan con tu b칰squeda',
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        }
        
        // Event listener para b칰squeda con debounce
        const searchInput = document.getElementById('producto-search');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchProducts(this.value);
                }, 300); // Debounce de 300ms
            });
        }
        
        // Funci칩n para actualizar cantidad
        function updateCantidad(detalleId, action) {
            const cantidadElement = document.querySelector(`.quantity-value[data-detalle-id="${detalleId}"]`);
            if (!cantidadElement) return;

            let cantidad = parseInt(cantidadElement.textContent);
            if (isNaN(cantidad)) return;

            // Actualizaci칩n provisional
            if (action === 'incrementar') {
                cantidad += 1;
            } else if (action === 'decrementar' && cantidad > 1) {
                cantidad -= 1;
            } else {
                return;
            }

            cantidadElement.textContent = cantidad;
            cantidadElement.classList.add('pulse');

            const csrfToken = getCsrfToken();
            const categoriaActiva = localStorage.getItem('categoriaActiva') || 'all';

            fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `action=update_cantidad&detalle_id=${detalleId}&cantidad=${cantidad}&categoria_activa=${categoriaActiva}`
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.success) {
                    // Actualizar subtotal
                    const subtotalElement = document.querySelector(`.cart-item-price[data-detalle-id="${detalleId}"]`);
                    if (subtotalElement) {
                        subtotalElement.textContent = `$${parseFloat(data.subtotal).toFixed(0)}`;
                        subtotalElement.classList.add('pulse');
                        setTimeout(() => subtotalElement.classList.remove('pulse'), 300);
                    }

                    // Actualizar total
                    const totalElement = document.querySelector('.total-amount');
                    if (totalElement) {
                        totalElement.textContent = `$${parseFloat(data.total).toFixed(0)}`;
                        totalElement.classList.add('pulse');
                        setTimeout(() => totalElement.classList.remove('pulse'), 300);
                    }
                }
            })
            .catch(error => {
                handleFetchError(error, 'Error al actualizar la cantidad');
                window.location.reload(); // Recargar para sincronizar
            });
        }
                
        // Funci칩n para eliminar producto
        function removeProduct(detalleId) {
            const categoriaActiva = localStorage.getItem('categoriaActiva') || 'all';
            const csrfToken = getCsrfToken();
            
            fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `action=remove_producto&detalle_id=${detalleId}&categoria_activa=${categoriaActiva}`
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else if (response.ok) {
                    window.location.reload();
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            })
            .catch(error => {
                handleFetchError(error, 'Error al eliminar el producto');
            });
        }
        
        // Event listeners principales con delegaci칩n de eventos
        document.addEventListener('click', function(e) {
            // Incrementar cantidad
            if (e.target.closest('.incrementar')) {
                const detalleId = e.target.closest('.incrementar').dataset.detalleId;
                if (detalleId) {
                    updateCantidad(detalleId, 'incrementar');
                }
            }
            
            // Decrementar cantidad
            if (e.target.closest('.decrementar')) {
                const detalleId = e.target.closest('.decrementar').dataset.detalleId;
                if (detalleId) {
                    updateCantidad(detalleId, 'decrementar');
                }
            }
            
            // Eliminar producto
            if (e.target.closest('.remove-btn')) {
                e.preventDefault();
                const detalleId = e.target.closest('.remove-btn').dataset.detalleId;
                
                if (detalleId) {
                    Swal.fire({
                        title: '쮼liminar producto?',
                        text: "쮼st치s seguro de que quieres eliminar este producto del carrito?",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#dc3545',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'S칤, eliminar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            removeProduct(detalleId);
                        }
                    });
                }
            }
            
            // Cerrar modal al hacer clic fuera
            const modal = document.getElementById('noteModal');
            if (e.target === modal) {
                closeNoteModal();
            }
        });
        
        // Feedback para botones de agregar
        document.querySelectorAll('.add-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Guardar estilos originales
                const originalHTML = this.innerHTML;
                const originalBgColor = this.style.backgroundColor;
                
                // Cambiar a estado de 칠xito
                this.innerHTML = '<i class="fas fa-check"></i>';
                this.style.backgroundColor = '#28a745';
                
                setTimeout(() => {
                    this.innerHTML = originalHTML;
                    this.style.backgroundColor = originalBgColor;
                }, 1000);
                
                // Notificaci칩n toast
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });
                
                Toast.fire({
                    icon: 'success',
                    title: 'Producto agregado'
                });
            });
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeNoteModal();
            }
        });
        
        // Confirmar nota con Enter en el input
        const noteInput = document.getElementById('noteInput');
        if (noteInput) {
            noteInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    confirmNote();
                }
            });
        }

        // Guardar nombre del cliente
        document.getElementById('guardar-cliente').addEventListener('click', function() {
            const nombreCliente = document.getElementById('nombre_cliente').value.trim();
            const csrfToken = getCsrfToken();
            
            fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `action=actualizar_cliente&nombre_cliente=${encodeURIComponent(nombreCliente)}`
            })
            .then(response => {
                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Nombre guardado',
                        text: 'El nombre del cliente se ha actualizado',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            })
            .catch(error => {
                handleFetchError(error, 'Error al guardar el nombre');
            });
        });
    });
    
</script>
{% endblock %}
